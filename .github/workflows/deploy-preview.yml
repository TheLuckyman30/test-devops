# .github/workflows/preview.yml
name: Deploy PR Previews
concurrency: preview-${{ github.ref }}

permissions:
  contents: write
  pull-requests: write
  deployments: write

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    branches: [main]
jobs:
  Deploy-Preview:
    runs-on: ubuntu-latest
    environment:
      name: Preview
      url: https://theluckyman30.github.io/test-devops/pr-preview/pr-${{ github.event.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install & Build
        if: github.event.action != 'closed'
        run: npm ci && npm run build
        env:
          BASE_TYPE: 1
          PR_NUMBER: ${{ github.event.number }}

      - name: Deploy
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: ./dist
          preview-branch: gh-pages
          umbrella-dir: pr-preview
          action: auto

      - name: Delete deployments for this PR
        if: github.event.action == 'closed'
        run: |
          ENV_NAME="Preview"
          PR_NUMBER="${{ github.event.number }}"
          REPO="${{ github.repository }}"

          echo "Deleting deployments for PR $PR_NUMBER in environment $ENV_NAME"

          # 1. Get all deployments in the environment
          DEPLOYMENTS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                                  -H "Accept: application/vnd.github+json" \
                                  https://api.github.com/repos/$REPO/deployments)

          # 2. Filter deployments by environment and PR number
          DEPLOYMENT_IDS=$(echo "$DEPLOYMENTS_JSON" | jq -r ".[] | select(.environment==\"$ENV_NAME\" and .payload.pull_request.number==$PR_NUMBER) | .id")

          # 3. Delete each deployment
          for ID in $DEPLOYMENT_IDS; do
            echo "Deleting deployment $ID"
            curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/$REPO/deployments/$ID
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
